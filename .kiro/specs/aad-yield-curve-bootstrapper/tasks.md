# Implementation Plan

## Task Overview

AAD対応イールドカーブ・ブートストラッパーの実装タスク。既存の `pricer_optimiser::bootstrapping` モジュールを拡張し、ジェネリック型サポート、複数市場商品、陰関数定理によるAAD感応度計算を追加する。

---

## Tasks

- [ ] 1. 基盤コンポーネント（エラー型・設定）
- [ ] 1.1 (P) ブートストラップ専用エラー型の実装
  - 収束失敗、満期重複、データ不足、負レート、アービトラージ検出の各バリアントを定義
  - 既存の`SolverError`と`MarketDataError`からの変換を実装
  - 各エラーに満期点や残差などの診断情報を含める
  - `thiserror`によるエラーメッセージのフォーマット
  - _Requirements: 7.2, 7.4, 7.5_

- [ ] 1.2 (P) ブートストラップ設定構造体の実装
  - 収束許容誤差（デフォルト1e-12）、最大反復回数、補間方式を設定可能に
  - 外挿許可と負レート許可のフラグを追加
  - `Default`トレイトによるデフォルト値の提供
  - ジェネリック型`T: Float`でAD互換性を確保
  - _Requirements: 2.6, 7.1_

- [ ] 2. 市場商品入力
- [ ] 2.1 BootstrapInstrument enumの実装
  - OIS、IRS、FRA、金利先物の4商品タイプをバリアントとして定義
  - 各商品の満期、レート、支払頻度などのパラメータを保持
  - 静的ディスパッチによるEnzyme最適化互換性を維持
  - ジェネリック型`T: Float`でAD互換性を確保
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 8.3_

- [ ] 2.2 商品共通メソッドの実装
  - 満期取得、レート取得の共通インターフェースを提供
  - 満期重複検出ロジックを実装
  - 50年までの満期範囲をサポート
  - _Requirements: 1.5, 1.6_

- [ ] 2.3 商品別残差関数の実装
  - OIS: 単純割引からのディスカウント・ファクター計算
  - IRS: 固定レグ・フローティングレグ等価条件からの求解
  - FRA: フォワードレートからの計算
  - 先物: コンベクシティ調整を適用したフォワードレート変換
  - 残差関数とその導関数を各商品タイプに実装
  - _Requirements: 1.1, 1.2, 1.3, 1.4_

- [ ] 3. カーブ構築アルゴリズム
- [ ] 3.1 逐次ブートストラップエンジンの実装
  - 商品を満期順にソートして短期から長期へ順次処理
  - 各ピラーでNewton-Raphsonソルバーを使用してディスカウント・ファクターを求解
  - 中間結果を保持し部分的なカーブ構築を可能に
  - 入力レートを1bp以内で再現する精度を確保
  - _Requirements: 2.1, 2.2, 2.4_

- [ ] 3.2 ソルバーフォールバック機構の実装
  - Newton-Raphson収束失敗時にBrent法へ自動切り替え
  - 収束判定の許容誤差を設定から取得
  - 使用したソルバーと反復回数を結果に含める
  - _Requirements: 2.5, 2.6, 9.2_

- [ ] 3.3 入力検証機能の実装
  - 空入力、満期重複、負レートの事前検証
  - アービトラージ・フリー条件（ディスカウント・ファクター単調減少）の検証
  - 検証失敗時の詳細エラー報告
  - _Requirements: 7.1, 7.3, 7.5, 7.6_

- [ ] 4. ブートストラップ結果カーブ
- [ ] 4.1 BootstrappedCurve構造体の実装
  - ピラーポイントとディスカウント・ファクターのベクターを保持
  - 補間方式の選択を保持
  - イミュータブル設計でスレッドセーフ性を確保
  - _Requirements: 4.5, 9.1_

- [ ] 4.2 YieldCurveトレイト実装
  - `discount_factor()`でピラー間を補間して任意満期のDFを計算
  - `zero_rate()`と`forward_rate()`のデフォルト実装を活用
  - 外挿時の挙動を設定に基づいて制御
  - _Requirements: 2.3, 9.1, 9.4_

- [ ] 4.3 (P) ログ線形・線形補間の実装
  - ログ線形補間（ログDF間の線形補間）をデフォルトとして実装
  - ゼロレート線形補間を代替として実装
  - 既存`pricer_core`のInterpolatorを活用
  - _Requirements: 4.1, 4.5_

- [ ] 4.4 (P) 三次スプライン補間の実装
  - 三次スプライン補間をゼロレートまたはログDF上で実装
  - スプライン係数のキャッシュによる再計算回避
  - AD互換性を確保するスムース関数の使用
  - _Requirements: 4.2, 4.6_

- [ ] 4.5 (P) モノトニック・キュービック補間の実装
  - Fritsch-Carlsonまたは類似アルゴリズムによる単調性保証
  - ディスカウント・ファクターの単調減少を補間レベルで維持
  - _Requirements: 4.3, 4.6_

- [ ] 4.6 (P) フラット・フォワード補間の実装
  - ピラー間で一定フォワードレートを仮定した補間
  - フォワードレートの不連続を許容するステップ補間
  - _Requirements: 4.4, 4.6_

- [ ] 5. AAD（随伴アルゴリズム微分）サポート
- [ ] 5.1 AdjointSolver構造体の実装
  - Newton-RaphsonとBrentソルバーをラップ
  - 求根結果に感応度情報を付加するSolveResult型を定義
  - フィーチャーフラグによるnum-dual/Enzymeモード切り替え
  - _Requirements: 3.5, 9.2_

- [ ] 5.2 陰関数定理による勾配計算の実装
  - ソルバー収束後に∂f/∂θと∂f/∂xを評価
  - 逆伝播用のアジョイント係数を計算: -∂f/∂θ / ∂f/∂x
  - 反復ステップをADテープに記録しない設計
  - _Requirements: 3.7, 3.8_

- [ ] 5.3 num-dualモードでの感応度計算
  - Dual64を使用したフォワードモードADによる勾配計算
  - すべての入力レートに対するDF感応度を計算
  - スムース近似関数による不連続点の回避
  - _Requirements: 3.1, 3.4, 3.5_

- [ ] 5.4 AAD付きブートストラップメソッドの実装
  - `bootstrap_with_sensitivities()`で感応度付き結果を返却
  - 100入力でもO(1)倍のコストで全感応度を計算
  - 感応度行列（DF × 入力レート）を効率的に構築
  - _Requirements: 3.1, 3.6_

- [ ] 5.5 バンプ・アンド・リバリュー検証機能
  - 有限差分法による感応度計算を参照実装として提供
  - AAD結果との比較検証機能を実装
  - 許容誤差内での一致を確認するテストヘルパー
  - _Requirements: 3.3_

- [ ] 6. マルチカーブ・フレームワーク
- [ ] 6.1 MultiCurveBuilder構造体の実装
  - 内部でCurveBootstrapperを使用したカーブ構築オーケストレーション
  - OIS割引カーブとテナーカーブの依存順序を管理
  - 単一カーブモードと割引カーブ参照モードの切り替え
  - _Requirements: 5.3, 5.5_

- [ ] 6.2 CurveSetとTenor定義の実装
  - 割引カーブとテナー別フォワードカーブを保持するCurveSet
  - Overnight、1M、3M、6M、12Mなどのテナー定義
  - テナーカーブ構築時に割引カーブを参照する依存関係処理
  - _Requirements: 5.1, 5.2, 5.4_

- [ ] 6.3 日付計算ヘルパーの実装
  - ACT/360、ACT/365、30/360などデイカウント慣行の適用
  - Following、Modified Following、Precedingの営業日調整
  - スポット日（T+2等）の計算
  - `infra_master`カレンダー機能との統合
  - _Requirements: 6.1, 6.2, 6.3, 6.4, 6.5_

- [ ] 7. パフォーマンス最適化
- [ ] 7.1 並列ブートストラップの実装
  - 複数カーブセットを同時構築するRayon並列処理
  - ワークスティーリングによる負荷分散
  - スレッドセーフなカーブ構築
  - _Requirements: 8.4_

- [ ] 7.2 メモリ効率最適化
  - 動的メモリアロケーションの最小化
  - 中間計算結果のキャッシュ機能
  - 100ポイントカーブを10ms以内で構築する性能目標
  - _Requirements: 8.1, 8.2, 8.5_

- [ ] 8. 統合テストと検証
- [ ] 8.1 単体テストの実装
  - 各商品タイプの残差計算テスト
  - 各補間方式の精度テスト
  - エラーケースのテスト
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 4.1, 4.2, 4.3, 4.4, 7.1, 7.2, 7.3, 7.4, 7.5, 7.6_

- [ ] 8.2 統合テストの実装
  - 完全なブートストラップフローのエンドツーエンドテスト
  - マルチカーブ構築フローのテスト
  - 入力レート再現精度テスト（1bp以内）
  - PricingContextとの統合テスト
  - _Requirements: 2.2, 5.1, 5.2, 5.3, 5.4, 5.5, 9.1, 9.3, 9.4_

- [ ] 8.3 AAD検証テストの実装
  - バンプ・アンド・リバリュー方式との感応度比較
  - O(1)コストの検証（100入力でのスケーラビリティ）
  - num-dualモードとEnzymeモードの結果一致確認
  - _Requirements: 3.1, 3.2, 3.3, 3.6_

- [ ] 8.4* パフォーマンスベンチマークの実装
  - 100ポイントカーブの構築時間計測
  - AAD感応度計算のスケーラビリティ測定
  - 並列ブートストラップのスループット測定
  - _Requirements: 8.1, 8.3_

---

## Requirements Coverage

| Requirement | Tasks |
|-------------|-------|
| 1.1, 1.2, 1.3, 1.4 | 2.1, 2.3, 8.1 |
| 1.5, 1.6 | 2.2 |
| 2.1, 2.2, 2.4 | 3.1 |
| 2.3 | 4.2 |
| 2.5, 2.6 | 1.2, 3.2 |
| 3.1 | 5.3, 5.4, 8.3 |
| 3.2, 3.3 | 5.5, 8.3 |
| 3.4, 3.5 | 5.1, 5.3 |
| 3.6 | 5.4, 8.3 |
| 3.7, 3.8 | 5.2 |
| 4.1, 4.5 | 4.1, 4.3 |
| 4.2 | 4.4 |
| 4.3 | 4.5 |
| 4.4 | 4.6 |
| 4.6 | 4.3, 4.4, 4.5, 4.6 |
| 5.1, 5.2 | 6.2 |
| 5.3, 5.5 | 6.1 |
| 5.4 | 6.2 |
| 6.1, 6.2, 6.3, 6.4, 6.5 | 6.3 |
| 7.1, 7.2, 7.4, 7.5 | 1.1, 3.3, 8.1 |
| 7.3, 7.6 | 3.3 |
| 8.1, 8.2, 8.5 | 7.2 |
| 8.3 | 2.1, 8.4 |
| 8.4 | 7.1 |
| 9.1, 9.4 | 4.1, 4.2, 8.2 |
| 9.2 | 3.2, 5.1 |
| 9.3 | 8.2 |
| 9.5 | 1.2, 2.1 |
