# Gap Analysis: checkpointing-path-dependent-ad

## ç¾çŠ¶èª¿æŸ»

### æ—¢å­˜è³‡ç”£ã®æ¦‚è¦

#### L3 (pricer_kernel) - ç¾åœ¨ã®å®Ÿè£…çŠ¶æ…‹

| ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ | çŠ¶æ…‹ | è©³ç´° |
|---------------|------|------|
| `mc/workspace.rs` | âœ… å®Œäº† | PathWorkspaceï¼ˆrandoms, paths, payoffs ãƒãƒƒãƒ•ã‚¡ç®¡ç†ï¼‰ |
| `mc/payoff.rs` | ğŸ”¸ éƒ¨åˆ†çš„ | European/Asianç®—è¡“å¹³å‡ã®smooth payoffå®Ÿè£…æ¸ˆã¿ |
| `mc/paths.rs` | âœ… å®Œäº† | GBMãƒ‘ã‚¹ç”Ÿæˆã€tangent propagation for spot |
| `enzyme/mod.rs` | ğŸ”¸ éƒ¨åˆ†çš„ | Activity enumå®šç¾©ã€finite difference placeholder |
| `checkpoint/mod.rs` | âŒ æœªå®Ÿè£… | ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã®ã¿ |
| `rng/` | âœ… å®Œäº† | PricerRng with reproducible seeding |

**é‡è¦**: L3ã¯ç¾åœ¨pricer_*ã‚¯ãƒ¬ãƒ¼ãƒˆã¸ã®ä¾å­˜ãŒã‚¼ãƒ­ï¼ˆå®Œå…¨åˆ†é›¢çŠ¶æ…‹ï¼‰

#### L1 (pricer_core) - å†åˆ©ç”¨å¯èƒ½ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

| ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ | ãƒ‘ã‚¹ | çµ±åˆå„ªå…ˆåº¦ |
|---------------|------|-----------|
| smoothingé–¢æ•° | `math/smoothing.rs` | é«˜ |
| Float trait | `traits/mod.rs` | é«˜ |
| YieldCurve trait | `market_data/curves/traits.rs` | é«˜ |
| FlatCurve | `market_data/curves/flat.rs` | ä¸­ |
| InterpolatedCurve | `market_data/curves/interpolated.rs` | ä¸­ |

#### L2 (pricer_models) - å†åˆ©ç”¨å¯èƒ½ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

| ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ | ãƒ‘ã‚¹ | çµ±åˆå„ªå…ˆåº¦ |
|---------------|------|-----------|
| StochasticModel trait | `models/stochastic.rs` | é«˜ |
| Instrument enum | `instruments/mod.rs` | é«˜ |
| GBM model | `models/gbm.rs` | ä¸­ |
| analytical module | `analytical/mod.rs` | ä½ï¼ˆãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ï¼‰ |

---

## è¦ä»¶å®Ÿç¾å¯èƒ½æ€§åˆ†æ

### Requirement 1: ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆåŸºç›¤

| æŠ€è¡“è¦ç´  | ç¾çŠ¶ | ã‚®ãƒ£ãƒƒãƒ— |
|----------|------|----------|
| CheckpointManager | âŒ Missing | æ–°è¦ä½œæˆãŒå¿…è¦ |
| CheckpointStrategy | âŒ Missing | å‡ç­‰ãƒ»å¯¾æ•°ãƒ»é©å¿œçš„æˆ¦ç•¥ã®è¨­è¨ˆãŒå¿…è¦ |
| çŠ¶æ…‹ä¿å­˜/å¾©å…ƒ | âŒ Missing | ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ã®ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚º |
| ADçµ±åˆ | ğŸ”¬ Research | Enzymeã¨ã®ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆç›¸äº’ä½œç”¨èª¿æŸ»ãŒå¿…è¦ |

**è¤‡é›‘æ€§**: é«˜ - ADæ–‡è„ˆã§ã®ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆæˆ¦ç•¥ã¯å°‚é–€çš„çŸ¥è­˜ãŒå¿…è¦

### Requirement 2: ãƒ‘ã‚¹ä¾å­˜ã‚ªãƒ—ã‚·ãƒ§ãƒ³

| æŠ€è¡“è¦ç´  | ç¾çŠ¶ | ã‚®ãƒ£ãƒƒãƒ— |
|----------|------|----------|
| PathDependentPayoff trait | âŒ Missing | æ–°è¦traitè¨­è¨ˆ |
| PathObserver | âŒ Missing | çµŒè·¯çµ±è¨ˆè“„ç©ã®ä»•çµ„ã¿ |
| Asian Option (ç®—è¡“) | âœ… Exists | `asian_arithmetic_call/put_smooth` in payoff.rs |
| Asian Option (å¹¾ä½•) | âŒ Missing | å¹¾ä½•å¹³å‡ãƒšã‚¤ã‚ªãƒ•ã®è¿½åŠ  |
| Barrier Option | âŒ Missing | 8ç¨®é¡ï¼ˆUp/Down Ã— In/Out Ã— Call/Putï¼‰ |
| Lookback Option | âŒ Missing | Fixed/Floating strike variants |
| Smooth barrier approx | ğŸ”¬ Research | smooth_indicatorãƒ™ãƒ¼ã‚¹ã®ãƒãƒªã‚¢è¿‘ä¼¼ |

**è¤‡é›‘æ€§**: ä¸­ - æ—¢å­˜ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆsmooth payoffï¼‰ã®æ‹¡å¼µ

### Requirement 3: ãƒ¡ãƒ¢ãƒªç®¡ç†

| æŠ€è¡“è¦ç´  | ç¾çŠ¶ | ã‚®ãƒ£ãƒƒãƒ— |
|----------|------|----------|
| PathWorkspace | âœ… Exists | æ—¢å­˜ãƒãƒƒãƒ•ã‚¡ç®¡ç† |
| ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆç”¨ãƒãƒƒãƒ•ã‚¡ | âŒ Missing | PathWorkspaceæ‹¡å¼µã¾ãŸã¯æ–°æ§‹é€ ä½“ |
| MemoryBudget | âŒ Missing | ãƒ¡ãƒ¢ãƒªäºˆç®—ç®¡ç†ã®æ–°è¦è¨­è¨ˆ |
| Thread-local buffers | âŒ Missing | Rayonçµ±åˆç”¨ã®ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ­ãƒ¼ã‚«ãƒ«è¨­è¨ˆ |
| reset/clear | âœ… Exists | PathWorkspace::reset() |

**è¤‡é›‘æ€§**: ä¸­ - æ—¢å­˜PathWorkspaceã®æ‹¡å¼µãŒä¸»

### Requirement 4: L1/L2çµ±åˆ

| æŠ€è¡“è¦ç´  | ç¾çŠ¶ | ã‚®ãƒ£ãƒƒãƒ— |
|----------|------|----------|
| Cargo.tomlä¾å­˜é–¢ä¿‚ | âŒ Missing | pricer_core, pricer_modelsä¾å­˜è¿½åŠ  |
| smoothingé–¢æ•°çµ±åˆ | âŒ Missing | local soft_plus â†’ pricer_core::math::smoothing |
| Float traitä½¿ç”¨ | âŒ Missing | pricer_core::traits::Float import |
| YieldCurveçµ±åˆ | âŒ Missing | å‰²å¼•è¨ˆç®—ã«YieldCurveä½¿ç”¨ |
| StochasticModelçµ±åˆ | âŒ Missing | GBM â†’ StochasticModelEnum |
| Instrument dispatch | âŒ Missing | Instrument enumã‹ã‚‰ãƒšã‚¤ã‚ªãƒ•è¨ˆç®— |

**è¤‡é›‘æ€§**: ä¸­ - æ˜ç¢ºãªçµ±åˆãƒã‚¤ãƒ³ãƒˆã€æŠ€è¡“çš„ãƒªã‚¹ã‚¯ä½

### Requirement 5: æ¤œè¨¼ã¨ãƒ†ã‚¹ãƒˆ

| æŠ€è¡“è¦ç´  | ç¾çŠ¶ | ã‚®ãƒ£ãƒƒãƒ— |
|----------|------|----------|
| ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆç­‰ä¾¡æ€§ãƒ†ã‚¹ãƒˆ | âŒ Missing | checkpointæœ‰ç„¡ã§ã®çµæœæ¯”è¼ƒ |
| Asianè§£æè§£æ¯”è¼ƒ | ğŸ”¬ Research | å¹¾ä½•å¹³å‡Asianç”¨BSå…¬å¼ |
| Barrierè§£æè§£æ¯”è¼ƒ | ğŸ”¬ Research | Black-Scholes barrier formulaå®Ÿè£… |
| Enzyme vs num-dualæ¤œè¨¼ | âŒ Missing | verify moduleã®æ‹¡å¼µ |
| ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ | âŒ Missing | criterion benchmarks |

**è¤‡é›‘æ€§**: ä¸­ - ãƒ†ã‚¹ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³ã¯ç¢ºç«‹æ¸ˆã¿

### Requirement 6: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹

| æŠ€è¡“è¦ç´  | ç¾çŠ¶ | ã‚®ãƒ£ãƒƒãƒ— |
|----------|------|----------|
| LTOè¨­å®š | âœ… Exists | Cargo.toml release profile |
| codegen-units=1 | âœ… Exists | æ—¢å­˜è¨­å®š |
| ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ | âŒ Missing | checkpoint overheadæ¸¬å®š |
| ä¸¦åˆ—å‡¦ç† | ğŸ”¸ Partial | Rayon available, æœªçµ±åˆ |

**è¤‡é›‘æ€§**: ä½ - æ—¢å­˜ã‚¤ãƒ³ãƒ•ãƒ©æ´»ç”¨

---

## å®Ÿè£…ã‚¢ãƒ—ãƒ­ãƒ¼ãƒé¸æŠè‚¢

### Option A: æ—¢å­˜ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ‹¡å¼µ

**å¯¾è±¡**: PathWorkspaceæ‹¡å¼µã€payoff.rsæ‹¡å¼µã€Cargo.tomlä¾å­˜è¿½åŠ 

**æ‹¡å¼µãƒã‚¤ãƒ³ãƒˆ**:
1. `PathWorkspace` ã«ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆç”¨ãƒãƒƒãƒ•ã‚¡è¿½åŠ 
2. `payoff.rs` ã«Barrier/Lookback smooth payoffè¿½åŠ 
3. `Cargo.toml` ã« pricer_core, pricer_modelsä¾å­˜è¿½åŠ 

**ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•**:
- âœ… æ—¢å­˜ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ´»ç”¨ã€é–‹ç™ºé€Ÿåº¦
- âœ… ãƒ•ã‚¡ã‚¤ãƒ«æ•°å¢—åŠ ã‚’æŠ‘åˆ¶
- âŒ PathWorkspaceãŒè¤‡é›‘åŒ–ã™ã‚‹ãƒªã‚¹ã‚¯
- âŒ è²¬å‹™ã®è‚¥å¤§åŒ–

### Option B: æ–°è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆä½œæˆ

**æ–°è¦ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«**:
1. `checkpoint/` - CheckpointManager, CheckpointStrategy, MemoryBudget
2. `path_dependent/` - PathDependentPayoff trait, PathObserver, å„ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ—
3. `integration/` - L1/L2çµ±åˆã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼

**ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•**:
- âœ… æ˜ç¢ºãªè²¬å‹™åˆ†é›¢
- âœ… ãƒ†ã‚¹ãƒˆå®¹æ˜“æ€§
- âœ… å°†æ¥ã®æ‹¡å¼µæ€§
- âŒ ãƒ•ã‚¡ã‚¤ãƒ«æ•°å¢—åŠ 
- âŒ åˆæœŸè¨­è¨ˆã‚³ã‚¹ãƒˆ

### Option C: ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ã‚¢ãƒ—ãƒ­ãƒ¼ãƒï¼ˆæ¨å¥¨ï¼‰

**æˆ¦ç•¥**:
1. **L1/L2çµ±åˆ**: Cargo.tomlä¿®æ­£ã€importå¤‰æ›´ï¼ˆæ—¢å­˜æ‹¡å¼µï¼‰
2. **ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ**: æ–°è¦ `checkpoint/` ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ä½œæˆ
3. **ãƒ‘ã‚¹ä¾å­˜ã‚ªãƒ—ã‚·ãƒ§ãƒ³**: æ–°è¦ `path_dependent/` ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« + `payoff.rs` ã® traitæŠ½å‡º
4. **PathWorkspace**: è»½å¾®ãªæ‹¡å¼µï¼ˆãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å‚ç…§ã®ã¿ï¼‰

**ãƒ•ã‚§ãƒ¼ã‚ºåˆ†å‰²**:
- Phase 4.1: L1/L2çµ±åˆï¼ˆä¾å­˜é–¢ä¿‚è§£æ±ºï¼‰
- Phase 4.2: ãƒ‘ã‚¹ä¾å­˜ã‚ªãƒ—ã‚·ãƒ§ãƒ³åŸºç›¤
- Phase 4.3: ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆæ©Ÿæ§‹
- Phase 4.4: æ¤œè¨¼ãƒ»ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯

**ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•**:
- âœ… ãƒªã‚¹ã‚¯åˆ†æ•£ï¼ˆæ®µéšçš„å®Ÿè£…ï¼‰
- âœ… å„ãƒ•ã‚§ãƒ¼ã‚ºã§å‹•ä½œç¢ºèªå¯èƒ½
- âœ… æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã¸ã®å½±éŸ¿æœ€å°åŒ–
- âŒ è¨ˆç”»ã®è¤‡é›‘ã•

---

## å®Ÿè£…è¤‡é›‘æ€§ã¨ãƒªã‚¹ã‚¯è©•ä¾¡

### å·¥æ•°è¦‹ç©ã‚‚ã‚Š

| è¦ä»¶ | å·¥æ•° | æ ¹æ‹  |
|------|------|------|
| Req 1: ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ | L (1-2é€±é–“) | æ–°è¦è¨­è¨ˆã€ADçµ±åˆç ”ç©¶å¿…è¦ |
| Req 2: ãƒ‘ã‚¹ä¾å­˜ã‚ªãƒ—ã‚·ãƒ§ãƒ³ | M (3-7æ—¥) | æ—¢å­˜ãƒ‘ã‚¿ãƒ¼ãƒ³æ‹¡å¼µ |
| Req 3: ãƒ¡ãƒ¢ãƒªç®¡ç† | S (1-3æ—¥) | PathWorkspaceæ‹¡å¼µ |
| Req 4: L1/L2çµ±åˆ | M (3-7æ—¥) | ä¾å­˜é–¢ä¿‚æ•´ç†ã€importå¤‰æ›´ |
| Req 5: æ¤œè¨¼ãƒ†ã‚¹ãƒˆ | M (3-7æ—¥) | è§£æè§£èª¿æŸ»å«ã‚€ |
| Req 6: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ | S (1-3æ—¥) | ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯è¿½åŠ  |

**ç·åˆå·¥æ•°**: Lï½XLï¼ˆå…¨ä½“ã§2-3é€±é–“ï¼‰

### ãƒªã‚¹ã‚¯è©•ä¾¡

| ãƒªã‚¹ã‚¯ | ãƒ¬ãƒ™ãƒ« | ç·©å’Œç­– |
|--------|--------|--------|
| Enzyme + ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆç›¸äº’ä½œç”¨ | é«˜ | å…ˆè¡Œèª¿æŸ»ã€ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—æ¤œè¨¼ |
| nightly Rustäº’æ›æ€§ | ä¸­ | rust-toolchain.tomlå›ºå®šæ¸ˆã¿ |
| L1/L2çµ±åˆã§ã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ | ä½ | æ®µéšçš„çµ±åˆã€CIç¢ºèª |
| ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›®æ¨™æœªé” | ä¸­ | æ—©æœŸãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã€æˆ¦ç•¥èª¿æ•´ |

---

## è¨­è¨ˆãƒ•ã‚§ãƒ¼ã‚ºã¸ã®æ¨å¥¨äº‹é …

### å„ªå…ˆèª¿æŸ»é …ç›®ï¼ˆResearch Neededï¼‰

1. **Enzymeãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ**: Enzyme ADã§ã®checkpointing best practices
2. **Barrier smooth approximation**: smooth_indicatoré–¢æ•°ã®ãƒãƒªã‚¢é©ç”¨ç²¾åº¦
3. **å¹¾ä½•å¹³å‡Asianè§£æè§£**: Black-Scholesãƒ™ãƒ¼ã‚¹ã®é–‰å½¢å¼è§£
4. **Barrierè§£æè§£**: é€£ç¶šç›£è¦–ãƒãƒªã‚¢ã®Black-Scholeså…¬å¼

### æ¨å¥¨å®Ÿè£…é †åº

1. **L1/L2çµ±åˆã‚’æœ€åˆã«** - ä»–ã®å…¨ã¦ãŒä¾å­˜
2. **ãƒ‘ã‚¹ä¾å­˜ã‚ªãƒ—ã‚·ãƒ§ãƒ³** - ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆãªã—ã§å‹•ä½œç¢ºèªå¯èƒ½
3. **ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ** - ãƒ‘ã‚¹ä¾å­˜ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®æœ€é©åŒ–ã¨ã—ã¦è¿½åŠ 
4. **æ¤œè¨¼ãƒ»ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯** - å…¨æ©Ÿèƒ½å®Œæˆå¾Œ

### è¨­è¨ˆä¸Šã®é‡è¦æ±ºå®šäº‹é …

1. **PathDependentPayoff traitè¨­è¨ˆ**: ãƒšã‚¤ã‚ªãƒ•è¨ˆç®—ã®ãŸã‚ã®çµ±ä¸€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
2. **PathObserverè¨­è¨ˆ**: çµŒè·¯çµ±è¨ˆã®è“„ç©æ–¹æ³•ï¼ˆstreaming vs batchï¼‰
3. **CheckpointStrategyé¸æŠ**: ã©ã®æˆ¦ç•¥ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«ã™ã‚‹ã‹
4. **MemoryBudget API**: è‡ªå‹•èª¿æ•´ã®ãƒˆãƒªã‚¬ãƒ¼æ¡ä»¶

---

_ç”Ÿæˆæ—¥: 2026-01-01_
_åˆ†æè€…: Claude Code_
