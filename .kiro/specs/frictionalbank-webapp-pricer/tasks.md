# Implementation Plan

## Task Overview

FrictionalBank WebAppにインタラクティブなプライサー機能を追加するための実装タスク。バックエンドAPI（Rust/axum）とフロントエンドUI（HTML/JS）の両方を実装し、pricer_pricing（L3）との統合を行う。

---

## Tasks

- [x] 1. バックエンド型定義の作成
- [x] 1.1 (P) プライサーAPI用リクエスト/レスポンス型の定義
  - 価格計算リクエスト型（商品タイプ、パラメータ、Greeks計算フラグ）を定義
  - 商品タイプ別パラメータ（Equity Option、FX Option、IRS）を列挙型で定義
  - 価格計算レスポンス型（計算ID、PV、Greeks、タイムスタンプ）を定義
  - Greeks結果型（Delta、Gamma、Vega、Theta、Rho）を定義
  - エラーレスポンス型（エラータイプ、メッセージ、フィールド）を定義
  - JSONシリアライゼーション（camelCase）対応の属性を適用
  - _Requirements: 2.1, 2.2, 2.3, 3.2, 3.5, 4.1, 4.2_

- [x] 1.2 (P) デモ用市場データ生成機能の実装
  - デフォルトイールドカーブ（フラットカーブ）の生成関数を実装
  - デフォルトボラティリティサーフェスの生成関数を実装
  - 市場データ設定型（Demo/Custom切り替え）を定義
  - _Requirements: 6.1, 6.2, 6.3, 6.4_

- [x] 2. 価格計算APIエンドポイントの実装
- [x] 2.1 価格計算ハンドラーの実装
  - リクエストパラメータのバリデーション（必須項目、数値範囲、正数チェック）を実装
  - 商品タイプ別にpricer_modelsのInstrumentEnumへ変換するロジックを実装
  - PricingContextを使用して価格計算を実行する処理を実装
  - Greeks計算オプションに応じてGreeks値を計算する処理を実装
  - 計算結果をレスポンス型に変換して返却する処理を実装
  - pricer層エラーを適切なHTTPステータスコード（422）で返却
  - _Requirements: 3.1, 3.2, 3.4, 5.1, 5.2, 5.3, 5.4, 5.5_

- [x] 2.2 APIルートの登録
  - 新規エンドポイント（POST /api/price）をルーターに追加
  - pricer_typesモジュールを公開設定
  - _Requirements: 3.1_

- [x] 3. WebSocket通知機能の拡張
- [x] 3.1 価格計算完了通知の実装
  - RealTimeUpdate構造に価格計算完了イベントを追加
  - 計算完了時にWebSocketでブロードキャストする処理を実装
  - 通知データに計算ID、商品タイプ、PV、Greeksを含める
  - _Requirements: 3.2_

- [x] 4. フロントエンドUI構造の実装
- [x] 4.1 Pricerタブのナビゲーション追加
  - ヘッダーナビゲーションにPricerタブリンクを追加
  - タブ切り替え時のコンテンツ表示切り替えロジックを実装
  - _Requirements: 1.1_

- [x] 4.2 商品選択インターフェースの実装
  - 商品タイプ選択ドロップダウン（Equity Vanilla Option、FX Option、IRS）を作成
  - 各商品タイプに対応するラベルまたはアイコンを表示
  - 商品選択時に対応するパラメータフォームを動的に切り替える処理を実装
  - _Requirements: 1.1, 1.2, 1.3_

- [x] 4.3 (P) Equity Optionパラメータフォームの実装
  - スポット価格、ストライク、満期（年）の数値入力フィールドを作成
  - ボラティリティ、金利の数値入力フィールドを作成
  - オプションタイプ（Call/Put）選択を作成
  - 必須フィールドの入力バリデーションとエラー表示を実装
  - _Requirements: 2.1, 2.4, 2.5_

- [x] 4.4 (P) FX Optionパラメータフォームの実装
  - スポットレート、ストライク、満期（年）の数値入力フィールドを作成
  - ドメスティック金利、フォーリン金利、ボラティリティの入力フィールドを作成
  - オプションタイプ（Call/Put）選択を作成
  - 必須フィールドの入力バリデーションとエラー表示を実装
  - _Requirements: 2.2, 2.4, 2.5_

- [x] 4.5 (P) IRSパラメータフォームの実装
  - 想定元本、固定レート、期間（年）の数値入力フィールドを作成
  - 必須フィールドの入力バリデーションとエラー表示を実装
  - _Requirements: 2.3, 2.4, 2.5_

- [x] 4.6 価格計算実行機能の実装
  - 「Calculate」ボタンの実装
  - フォームデータを収集してAPIリクエストを構築する処理を実装
  - 計算中のローディングインジケータ表示を実装
  - APIエラー時のエラーメッセージ表示を実装
  - _Requirements: 3.1, 3.3, 3.4_

- [x] 4.7 計算結果表示パネルの実装
  - PV（現在価値）を3桁区切りフォーマットで表示
  - Greeks値（Delta、Gamma、Vega、Theta、Rho）を適切な小数点桁数で表示
  - 正負のGreeks値を色分け（正：緑、負：赤）で視覚的に区別
  - _Requirements: 3.2, 3.5, 4.1, 4.2, 4.4_

- [x] 4.8 計算履歴パネルの実装
  - 計算完了時に履歴エントリを追加する処理を実装
  - 直近10件の計算履歴をサイドパネルに表示
  - 各履歴項目に計算日時と商品タイプを表示
  - 履歴項目クリック時にパラメータと結果を復元表示する処理を実装
  - LocalStorageへの履歴永続化を実装
  - _Requirements: 7.1, 7.2, 7.3, 7.4_

- [x] 5. スタイリングとレスポンシブ対応
- [x] 5.1 プライサーUIスタイルの実装
  - デスクトップ（1920px以上）向けの最適レイアウトを実装
  - タブレット（768px〜1919px）向けのレスポンシブレイアウトを実装
  - 入力フォームと結果表示の視覚的区分を明確化
  - WCAG 2.1 AA準拠のコントラスト比を適用
  - _Requirements: 8.1, 8.2, 8.3, 8.4_

- [x] 6. 統合と動作確認
- [x] 6.1 エンドツーエンド動作確認
  - 各商品タイプ（Equity Option、FX Option、IRS）の価格計算フローを確認
  - バリデーションエラー時のUI表示を確認
  - 履歴追加・復元機能の動作を確認
  - WebSocket通知の配信を確認
  - _Requirements: 1.1, 1.2, 1.3, 2.1, 2.2, 2.3, 3.1, 3.2, 3.3, 3.4, 3.5, 4.1, 4.2, 5.1, 5.2, 5.3, 7.1, 7.2, 7.3, 7.4_

---

## Requirements Coverage

| Requirement | Tasks |
|-------------|-------|
| 1.1, 1.2, 1.3 | 4.1, 4.2, 6.1 |
| 2.1 | 1.1, 4.3, 6.1 |
| 2.2 | 1.1, 4.4, 6.1 |
| 2.3 | 1.1, 4.5, 6.1 |
| 2.4, 2.5 | 4.3, 4.4, 4.5 |
| 3.1 | 2.1, 2.2, 4.6, 6.1 |
| 3.2 | 1.1, 2.1, 3.1, 4.7, 6.1 |
| 3.3 | 4.6, 6.1 |
| 3.4 | 2.1, 4.6, 6.1 |
| 3.5 | 1.1, 4.7, 6.1 |
| 4.1, 4.2, 4.4 | 1.1, 4.7, 6.1 |
| 5.1, 5.2, 5.3, 5.4, 5.5 | 2.1, 6.1 |
| 6.1, 6.2, 6.3, 6.4 | 1.2 |
| 7.1, 7.2, 7.3, 7.4 | 4.8, 6.1 |
| 8.1, 8.2, 8.3, 8.4 | 5.1 |

---

## Parallel Execution Notes

以下のタスクは並列実行可能：
- **1.1 + 1.2**: 型定義と市場データ生成は独立
- **4.3 + 4.4 + 4.5**: 各商品タイプのフォームは独立して実装可能

依存関係により順次実行が必要：
- **1.x → 2.x**: 型定義完了後にハンドラー実装
- **2.x → 3.x**: ハンドラー完了後にWebSocket統合
- **4.1 → 4.2**: タブ追加後に商品選択実装
- **4.2 → 4.6, 4.7, 4.8**: 商品選択後に計算・結果・履歴機能
- **5.x → 6.x**: スタイリング後に統合確認
