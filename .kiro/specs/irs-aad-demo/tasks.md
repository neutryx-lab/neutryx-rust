# Implementation Plan

## 概要

本タスクリストは、IRS AADデモ機能の実装を段階的に進めるための作業項目を定義する。AAD(Adjoint Algorithmic Differentiation)の性能優位性をBump-and-Revalue方式との比較を通じて実証し、FrictionalBankデモシステムに統合する。

---

## Tasks

- [x] 1. AAD統合技術スパイク
  - IRS価格評価関数に対するAAD適用方針を検証する
  - 既存GreeksEnzymeトレイト拡張 vs IRS専用AADトレイト新設の技術的トレードオフを評価する
  - Enzyme `#[autodiff]`マクロをprice_irs関数に適用し、全テナーDeltaの単一逆伝播計算が可能か検証する
  - AADテープ生成・再利用のメモリフットプリントを計測する
  - 検証結果に基づき後続タスクの実装方針を決定する
  - _Requirements: 2.1, 2.5_

- [ ] 2. IRS Greeks計算器
- [x] 2.1 IRS NPV計算機能の実装
  - IRSパラメータ(想定元本、固定レート、期間、通貨)からInterestRateSwapオブジェクトを生成する
  - 固定レグと変動レグの現在価値を計算する
  - スワップの正味現在価値(NPV)を返却する
  - 無効なパラメータ(負の想定元本、不正な日付範囲など)に対するエラー処理を実装する
  - pricer_modelsのInterestRateSwap構造体およびScheduleBuilderとの互換性を確保する
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5_

- [x] 2.2 (P) AADモードDelta計算の実装
  - タスク1のスパイク結果に基づき、AAD計算機能を実装する
  - EnzymeベースのADを使用して全テナーのDeltaを単一逆伝播で計算する
  - DV01(1bp金利変動に対するPV変化)を算出する
  - 計算時間をナノ秒精度で計測し記録する
  - _Requirements: 2.1, 2.4, 2.5, 2.6_

- [x] 2.3 (P) Bump-and-RevalueモードDelta計算の実装
  - 有限差分法によるテナーDelta計算を実装する
  - 各テナーポイントに対して順次bump適用とPV再計算を実行する
  - DV01を有限差分法で算出する
  - 計算時間をナノ秒精度で計測し記録する
  - _Requirements: 2.2, 2.4, 2.6_

- [x] 2.4 精度検証機能の実装
  - AAD計算結果とBump-and-Revalue計算結果を比較する
  - 相対誤差が許容値(1e-6)以内であることを検証する
  - 精度検証結果(各テナーの相対誤差)を記録する
  - _Requirements: 2.3_

- [ ] 3. LazyValuation機能
- [x] 3.1 依存関係グラフの構築
  - カーブテナーポイントとIRS計算の依存関係を追跡するグラフ構造を実装する
  - 各IRSがどのカーブポイントに依存するかをマッピングする
  - カーブ変更時に影響を受けるIRSを特定するクエリ機能を実装する
  - _Requirements: 3.3_

- [x] 3.2 キャッシュ管理の実装
  - IRS計算結果のキャッシュ機構を実装する
  - 同一市場データでの複数回価格評価時にキャッシュ結果を返却する
  - キャッシュキー(スワップハッシュ、カーブバージョン、評価日)の設計と実装
  - キャッシュ統計(ヒット数、ミス数、無効化数)の追跡
  - _Requirements: 3.2_

- [x] 3.3 カーブ更新通知と選択的再計算
  - カーブ更新イベントを受け取り、影響を受けるキャッシュを無効化する
  - 変更されたカーブポイントに依存する計算のみを再実行対象としてマークする
  - 次回評価要求時に自動的に再計算を実行する
  - _Requirements: 3.1, 3.4_

- [x] 3.4 AADテープ再利用機能
  - AAD計算で生成されたテープのキャッシュ機構を実装する
  - テープ再利用可否の判定ロジックを実装する
  - テープ再利用による計算効率化を実現する
  - _Requirements: 3.5_

- [x] 4. 性能ベンチマーク機能
- [x] 4.1 (P) ベンチマーク実行器の実装
  - PV計算、単一Delta計算、全テナーDelta計算の計測機能を実装する
  - 複数回反復(デフォルト100回)による統計値算出(平均、標準偏差、最小、最大)を実装する
  - ウォームアップ実行(デフォルト10回)を実装する
  - AADモードとBump-and-Revalueモードの速度比(speedup ratio)を計算する
  - _Requirements: 5.1, 5.2, 5.3_

- [x] 4.2 (P) スケーラビリティ計測の実装
  - テナーポイント数を変化させた計算時間計測を実装する
  - テナー数増加に伴う計算時間の推移データを生成する
  - AAD O(1)逆伝播 vs Bump O(n)のスケーリング特性を可視化用データとして出力する
  - _Requirements: 5.4_

- [x] 4.3 (P) ベンチマーク結果出力の実装
  - ベンチマーク結果をJSON形式で出力する機能を実装する
  - ベンチマーク結果をMarkdown形式で出力する機能を実装する
  - タイムスタンプ、スワップパラメータ、計測結果を含むスキーマを実装する
  - _Requirements: 5.5_

- [x] 5. XVAデモ
- [x] 5.1 エクスポージャープロファイル計算
  - 単一または複数のIRSポートフォリオに対するExpected Exposure(EE)プロファイルを計算する
  - 既存のExposureCalculatorと統合する
  - _Requirements: 4.1, 4.6_

- [x] 5.2 CVA/DVA計算
  - カウンターパーティ信用パラメータを入力としてCVAを計算する
  - 自社信用パラメータを入力としてDVAを計算する
  - 既存のXvaCalculatorと統合する
  - _Requirements: 4.2, 4.3, 4.6_

- [x] 5.3 XVA AAD感応度計算
  - AADを使用してXVA値のカーブ感応度を計算する
  - CVA/DVAのテナーDeltaを単一逆伝播で算出する
  - _Requirements: 4.4_

- [x] 5.4 XVA性能比較の実装
  - Bump-and-Revalueモードでの従来手法XVA感応度計算を実装する
  - AADモードとの性能比較結果を表示する
  - _Requirements: 4.5_

- [ ] 6. FrictionalBank統合
- [ ] 6.1 IrsAadWorkflowの実装
  - DemoWorkflowトレイトを実装し、FrictionalBankデモシステムに統合する
  - IRSパラメータ入力の処理機能を実装する
  - 計算モード選択(AAD/Bump-and-Revalue)機能を実装する
  - 単一計算とベンチマーク実行の両モードをサポートする
  - _Requirements: 6.1, 6.2, 6.5_

- [ ] 6.2 TUI画面の実装
  - IRS AAD Demo用のTUI画面(IrsAadScreen)を実装する
  - IRSパラメータ入力フォームを実装する
  - PV、Greeks、計算時間の結果表示を実装する
  - パラメータ変更時の即時再計算と結果更新を実装する
  - _Requirements: 6.2, 6.3, 6.6_

- [ ] 6.3 (P) WebSocket配信の実装
  - ベンチマーク結果をWebSocket経由でリアルタイム配信する機能を実装する
  - 既存のWeb dashboardインフラストラクチャを拡張する
  - _Requirements: 6.4_

- [ ] 7. 教育的可視化
- [ ] 7.1 (P) 計算フロー概念図の実装
  - AADとBump-and-Revalueの計算フローの概念図をTUI/Webで表示する
  - 両手法の違いを視覚的に説明する図を実装する
  - _Requirements: 7.1_

- [ ] 7.2 速度比較チャートの実装
  - ベンチマーク結果を速度比較バーチャートとして表示する
  - TUIモードではratatuiのChartウィジェットを使用する
  - Webモードではchart.js互換JSONデータを出力する
  - _Requirements: 7.2, 7.4, 7.5_

- [ ] 7.3 スケーラビリティグラフの実装
  - テナー数増加に伴う計算時間の比較折れ線グラフを表示する
  - AAD vs Bump-and-Revalueのスケーリング特性を可視化する
  - TUI/Web両モードに対応する
  - _Requirements: 7.3, 7.4, 7.5_

- [ ] 7.4 (P) 精度検証結果表示の実装
  - AAD vs Bump-and-Revalue差分の数値精度検証結果をテーブル表示する
  - 各テナーポイントの相対誤差を一覧表示する
  - _Requirements: 7.6_

- [ ] 8. 統合テストの実装
  - IrsAadWorkflowとIrsGreeksCalculatorの完全なワークフロー実行テストを実装する
  - 5年ATMスワップの完全なベンチマークサイクルをE2Eテストとして実装する
  - パラメータ変更による即時再計算のテストを実装する
  - LazyEvaluatorキャッシュ動作のテストを実装する
  - _Requirements: 1.1, 1.2, 1.3, 2.1, 2.2, 2.3, 3.1, 3.2, 5.1, 5.2, 6.1, 6.2, 6.3_
